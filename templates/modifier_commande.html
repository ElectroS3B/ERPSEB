{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>‚úèÔ∏è Modifier Commande : <span class="text-primary">{{ commande.numero_commande }}</span></h2>
        <a href="/historique_commandes" class="btn btn-outline-secondary">Annuler</a>
    </div>

    <form method="POST">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light fw-bold">Informations G√©n√©rales & Statut</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Client</label>
                        <select name="client_id" class="form-select" required>
                            {% for client in clients %}
                            <option value="{{ client.id }}" {% if client.id == commande.client_id %}selected{% endif %}>
                                {{ client.nom }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Date de livraison pr√©vue</label>
                        <input type="date" name="date_livraison" class="form-control" value="{{ commande.date_livraison_souhaitee }}" required>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Transporteur</label>
                        <select name="transporteur_id" class="form-select">
                            <option value="">-- Aucun --</option>
                            {% for t in transporteurs %}
                            <option value="{{ t.id }}" {% if t.id == commande.transporteur_id %}selected{% endif %}>
                                {{ t.nom }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Statut</label>
                        <select name="statut" class="form-select fw-bold border-primary">
                            <option value="En attente" {% if commande.statut == 'En attente' %}selected{% endif %}>‚è≥ En attente</option>
                            <option value="Valid√©e" {% if commande.statut == 'Valid√©e' %}selected{% endif %}>‚úÖ Valid√©e</option>
                            <option value="Exp√©di√©e" {% if commande.statut == 'Exp√©di√©e' %}selected{% endif %}>üöö Exp√©di√©e</option>
                            <option value="Annul√©e" {% if commande.statut == 'Annul√©e' %}selected{% endif %}>‚ùå Annul√©e</option>
                        </select>
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Observations</label>
                        <textarea name="observations" class="form-control" rows="2">{{ commande.observations }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light fw-bold">D√©tail des Produits</div>
            <div class="card-body">
                <div id="lignes-container">
                    {% for ligne in commande.lignes %}
                    <div class="row border-bottom mb-3 pb-3 ligne-commande">
                        <div class="col-md-3 mb-2">
                            <label class="small text-muted">Type</label>
                            <select name="type_produit_id[]" class="form-select form-select-sm type-selector" required>
                                {% for t in types %}
                                <option value="{{ t.id }}" {% if t.id == ligne.type_produit_id %}selected{% endif %}>{{ t.nom }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 mb-2">
                            <label class="small text-muted">Vari√©t√©</label>
                            <select name="variete_id[]" class="form-select form-select-sm variete-selector">
                                <option value="">-- Vari√©t√© --</option>
                                {% for v in varietes %}
                                <option value="{{ v.id }}" data-type="{{ v.type_produit_id }}" {% if v.id == ligne.variete_id %}selected{% endif %}>{{ v.nom }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 mb-2">
                            <label class="small text-muted">Calibre</label>
                            <select name="calibre_id[]" class="form-select form-select-sm">
                                <option value="">--</option>
                                {% for c in calibres %}
                                <option value="{{ c.id }}" {% if c.id == ligne.calibre_id %}selected{% endif %}>{{ c.nom }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 mb-2">
                            <label class="small text-muted">Conditionnement</label>
                            <select name="conditionnement_id[]" class="form-select form-select-sm">
                                {% for cond in conditionnements %}
                                <option value="{{ cond.id }}" {% if cond.id == ligne.conditionnement_id %}selected{% endif %}>{{ cond.nom }} ({{ cond.poids_unitaire }}kg)</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 mb-2">
                            <label class="small text-muted">Quantit√© / Poids</label>
                            <div class="input-group input-group-sm">
                                <input type="number" step="0.01" name="quantite[]" class="form-control" value="{{ ligne.quantite }}" required>
                                <button type="button" class="btn btn-outline-danger" onclick="this.closest('.ligne-commande').remove()">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="ajouterLigne()">‚ûï Ajouter un produit</button>
            </div>
        </div>

        <div class="text-end mb-5">
            <button type="submit" class="btn btn-primary px-5 shadow">üíæ Enregistrer les modifications</button>
        </div>
    </form>
</div>

<script>
    // R√©cup√©ration de la logique de filtrage (identique √† nouvelle_commande)
    function filtrerVarietes(selectType) {
        const typeId = String(selectType.value);
        const row = selectType.closest('.ligne-commande');
        const varieteSelect = row.querySelector('.variete-selector');
        const options = varieteSelect.querySelectorAll('option');

        options.forEach(opt => {
            const optType = String(opt.getAttribute('data-type'));
            if (opt.value === "" || (optType === typeId && typeId !== "")) {
                opt.style.display = "block";
            } else {
                opt.style.display = "none";
            }
        });
    }

    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('type-selector')) {
            filtrerVarietes(e.target);
        }
    });

    function ajouterLigne() {
        const container = document.getElementById('lignes-container');
        const lignes = document.querySelectorAll('.ligne-commande');
        let nouvelleLigne;
        
        if (lignes.length > 0) {
            nouvelleLigne = lignes[0].cloneNode(true);
            nouvelleLigne.querySelector('input[name="quantite[]"]').value = "";
            nouvelleLigne.querySelector('.type-selector').value = "";
            nouvelleLigne.querySelector('.variete-selector').value = "";
        }
        container.appendChild(nouvelleLigne);
    }

    // Au chargement : Appliquer le filtre sur chaque ligne existante
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.type-selector').forEach(sel => filtrerVarietes(sel));
    });
</script>
{% endblock %}