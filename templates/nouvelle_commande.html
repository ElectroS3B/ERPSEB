{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üìù Nouvelle Commande : <span class="text-success">{{ prochain_numero }}</span></h2>
        <a href="/historique_commandes" class="btn btn-outline-secondary">Annuler</a>
    </div>

    <form method="POST">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light fw-bold">Informations G√©n√©rales</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Client</label>
                        <select name="client_id" class="form-select select2-enable" required>
                            <option value="">S√©lectionner un client...</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.nom }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Date de livraison souhait√©e</label>
                        <input type="date" name="date_livraison" class="form-control" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Transporteur</label>
                        <select name="transporteur_id" class="form-select">
                            <option value="">-- Aucun / √Ä d√©finir --</option>
                            {% for t in transporteurs %}
                            <option value="{{ t.id }}">{{ t.nom }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Observations</label>
                        <textarea name="observations" class="form-control" rows="2" placeholder="Instructions de livraison..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light fw-bold">D√©tail des Produits</div>
            <div class="card-body">
                <div id="lignes-container">
                    <div class="row border-bottom mb-3 pb-3 ligne-commande">
                        <div class="col-md-3 mb-2">
                            <label class="small">Type</label>
                            <select name="type_produit_id[]" class="form-select form-select-sm type-selector" required>
                                <option value="">-- Choisir --</option>
                                {% for t in types %}
                                <option value="{{ t.id }}">{{ t.nom }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 mb-2">
                            <label class="small">Vari√©t√©</label>
                            <select name="variete_id[]" class="form-select form-select-sm variete-selector">
                                <option value="">-- Choisir Type --</option>
                                {% for v in varietes %}
                                <option value="{{ v.id }}" data-type="{{ v.type_produit_id }}">{{ v.nom }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 mb-2">
                            <label class="small">Calibre</label>
                            <select name="calibre_id[]" class="form-select form-select-sm">
                                <option value="">--</option>
                                {% for c in calibres %}
                                <option value="{{ c.id }}">{{ c.nom }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 mb-2">
                            <label class="small">Conditionnement</label>
                            <select name="conditionnement_id[]" class="form-select form-select-sm">
                                {% for cond in conditionnements %}
                                <option value="{{ cond.id }}">{{ cond.nom }} ({{ cond.poids_unitaire }}kg)</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 mb-2">
                            <label class="small">Quantit√© / Poids</label>
                            <input type="number" step="0.01" name="quantite[]" class="form-control form-control-sm" required>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="ajouterLigne()">‚ûï Ajouter un produit</button>
            </div>
        </div>

        <div class="text-end">
            <button type="submit" class="btn btn-success px-5">Enregistrer la commande</button>
        </div>
    </form>
</div>

<script>
    function filtrerVarietes(selectType) {
        const typeId = String(selectType.value); // Conversion en cha√Æne
        const row = selectType.closest('.ligne-commande');
        const varieteSelect = row.querySelector('.variete-selector');
        const options = varieteSelect.querySelectorAll('option');
    
        let premierTrouve = false;
    
        options.forEach(opt => {
            const optType = String(opt.getAttribute('data-type'));
            
            if (opt.value === "") {
                opt.style.display = "block";
            } else if (optType === typeId && typeId !== "") {
                opt.style.display = "block";
                if (!premierTrouve) {
                    opt.selected = true;
                    premierTrouve = true;
                }
            } else {
                opt.style.display = "none";
            }
        });
    
        if (!premierTrouve) {
            varieteSelect.value = "";
        }
    }
    
    // √âcouteur sur tout le document (pour les lignes ajout√©es dynamiquement)
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('type-selector')) {
            filtrerVarietes(e.target);
        }
    });

    function ajouterLigne() {
        const container = document.getElementById('lignes-container');
        const premiereLigne = document.querySelector('.ligne-commande');
        const nouvelleLigne = premiereLigne.cloneNode(true);
        
        // Reset des valeurs et affichage
        nouvelleLigne.querySelector('input[name="quantite[]"]').value = "";
        const selectType = nouvelleLigne.querySelector('.type-selector');
        const selectVar = nouvelleLigne.querySelector('.variete-selector');
        
        selectType.value = "";
        selectVar.value = "";
        
        // On r√©affiche toutes les options dans le clone avant le prochain filtrage
        selectVar.querySelectorAll('option').forEach(opt => opt.style.display = "block");
    
        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'col-md-12 text-end mt-1';
        deleteBtn.innerHTML = '<button type="button" class="btn btn-link btn-sm text-danger text-decoration-none" onclick="this.closest(\'.ligne-commande\').remove()">‚ùå Supprimer cette ligne</button>';
        nouvelleLigne.appendChild(deleteBtn);
        
        container.appendChild(nouvelleLigne);
    }

    // Au chargement initial : masquer les vari√©t√©s
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.type-selector').forEach(sel => filtrerVarietes(sel));
    });
</script>
{% endblock %}