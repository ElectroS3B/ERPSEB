{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>üîç Recherche et Historique</h2>
        <span class="badge bg-dark px-3 py-2">{{ produits|length }} r√©sultat(s) trouv√©(s)</span>
    </div>

    <div class="card bg-light mb-4 shadow-sm border-0">
        <div class="card-body">
            <form method="GET" action="{{ url_for('historique') }}" class="row g-3">
                
                <div class="col-md-2">
                    <label class="form-label small fw-bold text-secondary">Type</label>
                    <select name="type_id" class="form-select form-select-sm">
                        <option value="">Tous</option>
                        {% for t in types %}
                        <option value="{{ t.id }}" {% if request.args.get('type_id') == t.id|string %}selected{% endif %}>{{ t.nom }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label class="form-label small fw-bold text-secondary">Calibre</label>
                    <select name="calibre_id" class="form-select form-select-sm">
                        <option value="">Tous</option>
                        {% for c in calibres %}
                        <option value="{{ c.id }}" {% if request.args.get('calibre_id') == c.id|string %}selected{% endif %}>{{ c.nom }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label small fw-bold text-secondary">Parcelle</label>
                    <select name="parcelle_id" class="form-select form-select-sm">
                        <option value="">Toutes</option>
                        {% for p in parcelles %}
                        <option value="{{ p.id }}" {% if request.args.get('parcelle_id') == p.id|string %}selected{% endif %}>{{ p.nom }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label small fw-bold text-secondary">Client</label>
                    <select name="client_id" class="form-select form-select-sm">
                        <option value="">Tous les clients</option>
                        {% for cl in clients %}
                        <option value="{{ cl.id }}" {% if request.args.get('client_id') == cl.id|string %}selected{% endif %}>{{ cl.nom }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label small fw-bold text-primary">N¬∞ Bon de Livraison</label>
                    <select name="bl_numero" class="form-select form-select-sm select2-enable">
                        <option value="">Tous les BL</option>
                        {% for liv in livraisons %}
                            <option value="{{ liv.numero_bl }}" {% if request.args.get('bl_numero') == liv.numero_bl %}selected{% endif %}>
                                {{ liv.numero_bl }} - {{ liv.client_rel.nom }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label small fw-bold text-secondary">Statut</label>
                    <select name="statut" class="form-select form-select-sm">
                        <option value="">Tous</option>
                        <option value="STOCK" {% if request.args.get('statut') == 'STOCK' %}selected{% endif %}>En Stock</option>
                        <option value="SORTI" {% if request.args.get('statut') == 'SORTI' %}selected{% endif %}>Sorti (Perte)</option>
                        <option value="EXPEDIE" {% if request.args.get('statut') == 'EXPEDIE' %}selected{% endif %}>Exp√©di√©</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label small fw-bold text-secondary">Du</label>
                    <input type="date" name="date_debut" value="{{ request.args.get('date_debut', '') }}" class="form-control form-control-sm">
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold text-secondary">Au</label>
                    <input type="date" name="date_fin" value="{{ request.args.get('date_fin', '') }}" class="form-control form-control-sm">
                </div>

                <div class="col-md-6 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary btn-sm me-2 px-4 shadow-sm">Filtrer</button>
                    <a href="{{ url_for('historique') }}" class="btn btn-outline-secondary btn-sm px-4">R√©initialiser</a>
                </div>
            </form>
        </div>
    </div>

    <div class="table-responsive shadow-sm rounded">
        <table class="table table-sm table-striped table-hover align-middle mb-0">
            <thead class="table-dark">
                <tr>
                    <th class="ps-3">Date</th>
                    <th>Lot</th>
                    <th>Produit / Vari√©t√©</th>
                    <th>Calibre / Cond.</th>
                    <th>Parcelle</th>
                    <th class="text-end">Poids</th>
                    <th class="ps-4">Statut / Destination</th>
                </tr>
            </thead>
            <tbody>
                {% for p in produits %}
                <tr>
                    <td class="ps-3">{{ p.date_creation.strftime('%d/%m/%Y') }}</td>
                    <td><small class="text-muted fw-bold">#{{ p.id }}</small></td>
                    <td>
                        <span class="fw-bold text-dark">{{ p.type_rel.nom }}</span><br>
                        <small class="text-muted">{{ p.variete_rel.nom if p.variete_rel else '-' }}</small>
                    </td>
                    <td>
                        {{ p.calibre_rel.nom if p.calibre_rel else '-' }}<br>
                        <small class="text-muted">{{ p.cond_rel.nom if p.cond_rel else '-' }}</small>
                    </td>
                    <td>
                        <span class="badge border text-dark bg-white fw-normal px-2">
                            {{ p.parcelle_rel.nom if p.parcelle_rel else 'N/A' }}
                        </span>
                    </td>
                    <td class="fw-bold text-end pe-3">{{ p.poids_total }} kg</td>
                    <td class="ps-4">
                        {% if p.statut == 'STOCK' %}
                            <span class="badge bg-success shadow-sm">STOCK</span>
                        {% elif p.statut == 'SORTI' %}
                            <span class="badge bg-secondary">SORTI</span>
                        {% elif p.statut == 'EXPEDIE' %}
                            <span class="badge bg-primary shadow-sm">EXP√âDI√â</span>
                            
                            {% if p.historique_livraisons %}
                                {% for ligne in p.historique_livraisons %}
                                    <div class="mt-1">
                                        <small class="fw-bold text-primary">‚û°Ô∏è {{ ligne.livraison_rel.client_rel.nom if ligne.livraison_rel.client_rel else '?' }}</small><br>
                                        <small class="text-muted" style="font-size: 0.75rem;">BL: {{ ligne.livraison_rel.numero_bl }}</small>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <br><small class="text-danger small italic">D√©tail manquant</small>
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="text-center py-5 text-muted">Aucun lot trouv√©.</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot class="table-light border-top">
                <tr class="fw-bold">
                    <td colspan="5" class="text-end py-3 text-uppercase small">Poids total :</td>
                    <td class="text-end pe-3 py-3 text-primary fs-5">
                        {{ produits|sum(attribute='poids_total')|round(2) }} kg
                    </td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
{% endblock %}